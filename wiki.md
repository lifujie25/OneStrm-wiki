# OneStrm教程

## OneStrm部署

1. 使用`docker-compose`进行部署，新建`docker-compose.yml`文件，内容如下：
   ```yaml
   #需要用bridge桥接的网络方式，不要用 host
   version: '3.8'
   
   services:
     onestrm:
       image: lifj25/onestrm:latest
       container_name: onestrm
       restart: always
       ports:
         - "18003:18003"  # web管理页面
         - "18302:18302"  # 302播放地址
       volumes:
         - ./config:/app/config  # 保存配置文件，左侧路径可自行更改
         - F:\emby\media_onestrm:/movie_strm  # 保存strm 和元数据路径，左右侧路径可自行更改,请设置写入权限
       environment:
         - PUID=0
         - PGID=0
   ```

   注意点：

   - 可以修改web管理页面和302播放端口，如需把web端口改为9527，302播放端口改为9096，则把ports那一块更改为：
     ```yaml
           - "9527:18003"  # web管理页面
           - "9096:18302"  # 302播放地址
     ```

   - 路径映射：
     ```yaml
           - local_config_path:/app/config  # 保存配置文件，左侧路径可自行更改
           - local_strm_path:/movie_strm  # 保存strm 和元数据路径，左右侧路径可自行更改,请设置写入权限
     ```

     路径映射左侧路径可变为任意你想要的本地路径，右侧路径不能改变

   - `docker-compose up -d`启动docker

2. 使用`docker-cli`部署方式类似，不再赘述

## OneStrm配置

1. **为防止滥用，OneStrm带有授权机制，运行docker访问默认18003端口进入管理界面联系作者获取授权码**
2. 在获取激活码后，设置账号及对应密码进入管理界面
3. **注意所有配置修改后均需点击右下角保存方可生效**

### 用户中心配置

![image-20241221134546524](https://raw.githubusercontent.com/lifujie25/OneStrm-wiki/main/README.assets/image-20241221134546524.png)

其他配置不再赘述，这里TMDB密钥的填写主要有两个目的，一是oneStrm的登录页海报，另一个是为了在通知设置中，能够获取到对应入库影片的信息（后续再说）

### Cookies配置

![image-20241221134849802](README.assets\image-20241221134849802.png)

这里选取自己用不到的客户端，点击扫码，使用115手机端扫码即可获取对应客户端的cookies，可添加多个cookies来避免cookies失效，**填写完cookies后记得保存**

### Emby设置

![image-20241221135117894](README.assets\image-20241221135117894.png)

此处填写自己的Emby地址（一般为8096端口）以及Emby api即可，下面的两个选项作用如下：

- Emby刷新**(不建议启用)** ：如果Emby媒体库关闭实时监控，需开启该开关（建议启动Emby媒体库实时监控，并关闭该开关）；
- 最新入库显示：开启此选项会在仪表盘页面下方显示最新入库影片的信息，包括影片海报和影片名称

### Strm设置

![image-20241221135542340](README.assets\image-20241221135542340.png)

对应选项描述如下：

- 115网盘监控路径：填写115网盘中的对应路径，如果有多个路径，使用英文逗号进行分隔，如若添加路径为`/movie`和`/comic`，则此处填写`/movie,/comic`
- 本地保存路径：此处为容器映射后路径（不是主机上的路径），填写`/movie_strm`即可
- Strm内容前缀：若保持为空，则生成链接格式为不带http链接的路径
  - 勾选生成pickcode：生成链接带pickcode，不用cd2等软件也能获取媒体信息，但是需要302转发软件支持（Strm内容前缀保持默认）
  - 勾选短链：生成链接格式不带路径，只有文件名+pickcode
  - 推荐配置为Strm内容前缀填写`http://ip:port`（oneStrm网页管理链接），并开启生成pickcode和短链，这样的话生成strm内部链接格式为`http://ip:port/name?pickcode={pickcode}`，若生成正确，则此链接可直接在浏览器访问到对应资源
- 生成Strm大小限制：当网盘中文件大小大于此大小时才会生成strm
- 自动扫描间隔：假设输入为x，若x为0，则不自动扫描，若x>0，则会每隔x分钟扫描一次
- 视频文件后缀：只有视频文件的后缀才会生成strm，建议保持默认,如未有的格式用英文状态下：,.mpeg方式新增
- 其他文件后缀：对应选项"下载其他刮削文件",非图片、非.ass,.srt,.ssa的字幕，例如nfo等
- 三个选项
  - 下载字幕刮削文件：是否下载对应字幕文件，即以`.ass`、`.srt`的文件，若选择【(1)网盘路径】则为(1)中填写的网盘路径，若选择【(2)网盘路径】则为(2)中填写的网盘路径（选择【(2)网盘路径】会出现新的路径输入框）
  - 下载图片刮削文件和其他刮削文件选项与字幕刮削文件，如果有其他格式的文件需要下载，可在上面其他文件后缀中增加对应后缀
- 下面几个开关：
  - 增量扫描：扫描完后,本地删除strm 或者元数据，不会重新生成或下载,如果需要重新下载需要执行[单次全量扫描]、或者关闭增量扫描
  - 自动删除：网盘删除媒体文件后，自动删除本地已生成的 strm；
  - 删无strm文件夹：文件夹内没有strm整个文件夹删除，不管文件夹是否有其他内容，都直接删除文件夹
  - 实时监控：需借助cd2的实时监控功能，开启实时监控后，在[本程序地址]填入本程序的地址，保存后点击下载webhook，并把该文件上传到cd2的配置文件夹根目录，并重启cd2
  - 数据库代理：拉取数据库时候，如果是设备网络对115网盘不友好，可以代理方式拉取(如回国代理、香港等),http://ip:端口，开启后会出现两个选项，包括超时时间（拉取数据库，[一条记录]超过设置时间未拉取完成就失败）和代理地址

### 302转发设置

![image-20241221142547761](README.assets\image-20241221142547761.png)

1. **[如果是生成pickcode的方式，直接默认不需要修改]**
2. **[需替换的路径]** ：把本地路径非网盘的路径,如:/media/115/电影/爆款好人.mkv,网盘路径:/电影/爆款好人.mkv，这里就要填入/media/115
3. **[替换成]** ：[需替换的路径]填入的替换成，一般情况下留空即可

### 通知设置

#### 企业微信机器人

![image-20241221142929506](README.assets\image-20241221142929506.png)

手机端企业微信填写好对应信息新建企业，在群聊中的群机器人中新建一个群机器人，填写好对应信息后将生成的webhook地址输入到上述位置点击保存，再发送测试信息，能收到信息说明配置成功

#### 企业微信应用

笔者并不推荐使用这种方式配置，因为过于麻烦，需要你有一个可信域名或者位于公网的API接收接口

![image-20241221143121027](README.assets\image-20241221143121027.png)

1. 企业微信注册步骤与企业微信bot中相同
2. 进入企业微信后台管理界面[企业微信](https://work.weixin.qq.com/)，点击应用管理，创建应用，填写好对应信息，创建完毕
   ![image-20241221143344216](README.assets\image-20241221143344216.png)
3. 填写可信域名并下载对应文件到域名根目录，点击验证即可
   ![image-20241221143557378](README.assets\image-20241221143557378.png)
4. 验证完成后，在企业可信IP中增加自己云服务器IP，并在云服务器部署[lifj25/wxchat](https://hub.docker.com/r/lifj25/wxchat)
5. 填写上面需要的企业ID（我的企业->企业信息，下滑在最后即企业ID）、AgentID（点进应对应应用即可查看）、Secret（在AgentID下方，点击查看，在手机端企业微信即可查看）、代理地址（运行lifj25/wxchat这一docker的地址），保存后发送测试信息收到说明搭建成功

#### Telegram机器人

1. 创建Telegram机器人并获取API Token：在Telegram @BotFather按照提示创建对应bot，按照下图获取对应API Token
   ![image-20241221144315218](README.assets\image-20241221144315218.png)
2. 获取telegram聊天ID：浏览器输入`https://api.telegram.org/botYOUR_BOT_TOKEN/getUpdates`，其中`YOUR_BOT_TOKEN`替换为1中获取的API Token，在返回的json文件中找到id选项，即Telegram聊天id
3. 代理URL：即你的服务器或者本机的代理地址（如果无法直接访问tg）

#### 其他选项

- **[同步发送二维码]** ：不开启，默认发送一个图文，需要打开链接才能看到二维码；

- **[任务成功通知]** ：成功执行任务，发送结果到对应的客户端；

- **[CD2掉盘通知]** ：cd2挂载的路径丢失发送通知，重启cd2也可能会认为是掉盘；

- **[自定义图片]** ：发送通知时候，可以自定义顶部图片，但是该链接需要公网可访问，不可为局域网地址,不填入则使用默认，生成strm能能识别名字会自动获取图片；

- **[跳转链接]** ：发送通知,如非更新cookie，可以设置自定义跳转链接，即点开链接后跳转到什么地址
